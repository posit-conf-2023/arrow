{
  "hash": "a0adf38dd90e6d4d7f6149f06678bd1e",
  "result": {
    "markdown": "---\ntitle: \"Data Manipulation Part 2 - Exercises\"\nexecute:\n  echo: true\n  messages: false\n  warning: false\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(arrow)\nlibrary(dplyr)\nlibrary(duckdb)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nnyc_taxi <- open_dataset(here::here(\"data/nyc-taxi\"))\nnyc_taxi\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nFileSystemDataset with 120 Parquet files\nvendor_name: string\npickup_datetime: timestamp[ms]\ndropoff_datetime: timestamp[ms]\npassenger_count: int64\ntrip_distance: double\npickup_longitude: double\npickup_latitude: double\nrate_code: string\nstore_and_fwd: string\ndropoff_longitude: double\ndropoff_latitude: double\npayment_type: string\nfare_amount: double\nextra: double\nmta_tax: double\ntip_amount: double\ntolls_amount: double\ntotal_amount: double\nimprovement_surcharge: double\ncongestion_surcharge: double\npickup_location_id: int64\ndropoff_location_id: int64\nyear: int32\nmonth: int32\n```\n:::\n:::\n\n\n\n::: {#exercise-udfs .callout-tip}\n# User-defined functions\n\n::: panel-tabset\n## Problem\n\n1.  Write a user-defined function which wraps the `stringr` function `str_replace_na()`, and use it to replace any `NA` values in the `vendor_name` column with the string \"No vendor\" instead.\n\n## Solution 1\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Preview the distinct vendor names before we start\nnyc_taxi |>\n  filter(year == 2019) |> # smaller subset of the data\n  distinct(vendor_name) |>\n  collect()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 3 × 1\n  vendor_name\n  <chr>      \n1 CMT        \n2 VTS        \n3 <NA>       \n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nregister_scalar_function(\n  name = \"replace_vendor_na\",\n  function(context, string) {\n    stringr::str_replace_na(string, \"No vendor\")\n  },\n  in_type = schema(string = string()),\n  out_type = string(),\n  auto_convert = TRUE\n)\n\nvendor_names_fixed <- nyc_taxi |>\n  mutate(vendor_name = replace_vendor_na(vendor_name)) \n\n# Preview the distinct vendor names to check it's worked\nvendor_names_fixed |>\n  filter(year == 2019) |> # smaller subset of the data\n  distinct(vendor_name) |>\n  collect()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 3 × 1\n  vendor_name\n  <chr>      \n1 CMT        \n2 VTS        \n3 No vendor  \n```\n:::\n:::\n\n:::\n:::\n\n::: {#exercise-window .callout-tip}\n\n\n::: {#exercise-joins .callout-tip}\n# Joins\n\n::: panel-tabset\n## Problem\n\n1.  How many taxi pickups were recorded in 2019 from the three major airports covered by the NYC Taxis data set (JFK, LaGuardia, Newark)?\n\n## Solution 1\n\n\n::: {.cell}\n\n```{.r .cell-code}\npickup_location <- read_csv_arrow(here::here(\"data/taxi_zone_lookup.csv\"))\n\npickup_location <- pickup_location |>\n  select(\n    pickup_location_id = LocationID,\n    borough = Borough,\n    pickup_zone = Zone\n  ) |>\n  arrow_table(schema = schema(\n    pickup_location_id = int64(),\n    borough = utf8(),\n    pickup_zone = utf8()\n  ))\n\nnyc_taxi |>\n  filter(year == 2019) |>\n  left_join(pickup_location) |>\n  filter(str_detect(pickup_zone, \"Airport\")) |>\n  count(pickup_zone) |>\n  collect()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 3 × 2\n  pickup_zone             n\n  <chr>               <int>\n1 JFK Airport       2729336\n2 LaGuardia Airport 2159224\n3 Newark Airport       8643\n```\n:::\n:::\n\n:::\n:::\n\n::: {#exercise-window .callout-tip}\n# Window functions\n\n::: panel-tabset\n## Problem\n\n1.  How many trips in September 2019 had a longer than average distance for that month?\n\n## Solution 1\n\n### Option 1 - via DuckDB\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnyc_taxi |>\n  filter(year == 2019, month == 9) |>\n  to_duckdb() |>\n  mutate(mean_distance = mean(trip_distance)) |>\n  to_arrow() |>\n  filter(trip_distance < mean_distance) |>\n  count() |>\n  collect()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 × 1\n        n\n    <int>\n1 4881580\n```\n:::\n:::\n\n\n### Option 2 - via a join\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnyc_taxi |>\n  filter(year == 2019, month == 9) |>\n  left_join(\n    nyc_taxi |>\n      filter(year == 2019, month == 9) |>\n      group_by(year) |>\n      summarise(mean_distance = mean(trip_distance))\n    ) |>\n  filter(trip_distance < mean_distance) |>\n  count() |>\n  collect()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 × 1\n        n\n    <int>\n1 4881580\n```\n:::\n:::\n\n:::\n:::\n",
    "supporting": [
      "4_data_manipulation_2-exercises_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}